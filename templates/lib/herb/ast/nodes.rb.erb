module Herb
  module AST
    <%- nodes.each do |node| -%>
    #: type serialized_<%= node.human %> = {
      <%- node.fields.each do |field| -%>
      <%- is_nilable = !%w[Array[Herb::AST::Node] Array[Herb::AST::ERBWhenNode] Array[Herb::AST::ERBInNode] bool nil].include?(field.ruby_type) -%>
    #|  <%= field.name %>: <%= field.ruby_type %><%= if is_nilable then "?" end %>,
      <%- end -%>
    #| }
    class <%= node.name -%> < Node
      include Colors

      <%- node.fields.each do |field| -%>
      <%- is_nilable = !%w[Array[Herb::AST::Node] Array[Herb::AST::ERBWhenNode] Array[Herb::AST::ERBInNode] bool nil].include?(field.ruby_type) -%>
      attr_reader :<%= field.name %> #: <%= field.ruby_type %><%= if is_nilable then "?" end %>
      <%- end -%>

      #: (<%= ["String", "Location", "Array[Herb::Errors::Error]", *node.fields.map(&:ruby_type)].join(", ") %>) -> void
      def initialize(<%= ["type", "location", "errors", *node.fields.map(&:name)].join(", ") %>)
        super(type, location, errors)
        <%- node.fields.each do |field| -%>
        <%- if field.is_a?(Herb::Template::StringField) -%>
        @<%= field.name %> = <%= field.name %>.force_encoding("utf-8")
        <%- else -%>
        @<%= field.name %> = <%= field.name %>
        <%- end -%>
        <%- end -%>
      end

      #: () -> serialized_<%= node.human %>
      def to_hash
        super.merge({
          <%- node.fields.each do |field| -%>
          <%= field.name %>: <%= field.name %>,
          <%- end -%>
        }) #: Herb::serialized_<%= node.human %>
      end

      #: (Visitor) -> void
      def accept(visitor)
        visitor.visit_<%= node.human %>(self)
      end

      #: () -> Array[Herb::AST::Node?]
      def child_nodes
        [<%= node.fields.map { |field|
          if field.is_a?(Herb::Template::NodeField) || field.is_a?(Herb::Template::BorrowedNodeField)
            field.name
          elsif field.is_a?(Herb::Template::ArrayField) && (field.specific_kind&.end_with?("Node") || field.union_kind&.all? { |k| k.end_with?("Node") })
            "*(#{field.name} || [])"
          else
            nil
          end
        }.compact.join(", ") %>]
      end

      #: () -> Array[Herb::AST::Node]
      def compact_child_nodes
        child_nodes.compact
      end

      #: () -> String
      def inspect
        tree_inspect.rstrip.gsub(/\s+$/, "")
      end

      #: (?indent: Integer, ?depth: Integer, ?depth_limit: Integer) -> String
      def tree_inspect(indent: 0, depth: 0, depth_limit: 10)
        output = +""

        output += white("@ #{bold(yellow(node_name.to_s))} #{dimmed("(location: #{location.tree_inspect})")}")
        output += "\n"

        if depth >= depth_limit
          output += dimmed("└── [depth limit reached ...]\n\n")

          return output.gsub(/^/, "    " * indent)
        end

        output += inspect_errors(prefix: "<%= node.fields.any? ? "│   " : "    " %>")

        <%- node.fields.each do |field| -%>
        <%- symbol = node.fields.last == field ? "└──" : "├──" -%>
        <%- case field -%>
        <%- when Herb::Template::StringField -%>
        output += white("<%= symbol %> <%= field.name %>: ") + green("#{<%= field.name %>.inspect}\n")
        <%- when Herb::Template::TokenField -%>
        output += white("<%= symbol %> <%= field.name %>: ")
        output += <%= field.name %> ? <%= field.name %>.tree_inspect : magenta("∅")
        output += "\n"
        <%- when Herb::Template::BooleanField -%>
        output += white("<%= symbol %> <%= field.name %>: ")
        output += [true, false].include?(<%= field.name %>) ? bold(magenta(<%= field.name %>.to_s)) : magenta("∅")
        output += "\n"
        <%- when Herb::Template::LocationField -%>
        output += white("<%= symbol %> <%= field.name %>: ")
        output += <%= field.name %> ? dimmed("(location: #{<%= field.name %>.tree_inspect})") : magenta("∅")
        output += "\n"
        <%- when Herb::Template::ElementSourceField -%>
        output += white("<%= symbol %> <%= field.name %>: #{green(<%= field.name %>.inspect)}\n")
        <%- when Herb::Template::PrismNodeField -%>
        # no-op for <%= field.name %>
        <%- when Herb::Template::AnalyzedRubyField -%>
        # no-op for <%= field.name %>
        <%- when Herb::Template::NodeField, Herb::Template::BorrowedNodeField -%>
        output += white("<%= symbol %> <%= field.name %>: ")
        if <%= field.name %>
          <%- prefix = (node.fields.last == field) ? "    " : "│   " -%>
          output += "\n"
          <%- if (node.fields.last == field) -%>
          output += "    └── "
          <%- else -%>
          output += "│   └── "
          <%- end -%>
          output += <%= field.name %>.tree_inspect(indent: indent, depth: depth + 1, depth_limit: depth_limit).gsub(/^/, "    " * (indent + 1)).lstrip.gsub(/^/, "<%= prefix %>").delete_prefix("<%= prefix %>")
          <%- if false -%>
          <%- unless node.fields.last == field -%>
          output += "\n"
          output += white("<%= prefix %>\n")
          <%- end -%>
          <%- end -%>
        else
          output += magenta("∅\n")
        end
        <%- when Herb::Template::ArrayField -%>
        output += white("<%= symbol %> <%= field.name %>: ")
        output += inspect_array(<%= field.name %>, prefix: "<%= (node.fields.last == field) ? "    " : "│   " %>", indent: indent, depth: depth + 1, depth_limit: depth_limit)
        <%- else -%>
        <%- raise "Unhandled type: #{field.class}" -%>
        <%- end -%>
        <%- end -%>
        output += "\n"

        output.gsub(/^/, "    " * indent)
      end
    end

    <%- end -%>
  end
end
